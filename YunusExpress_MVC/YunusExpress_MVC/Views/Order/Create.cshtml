@using YunusExpress_MVC.Models
@using YunusExpress_MVC.ViewModels
@model OrderCreateVm

@{
    Layout = null;
    ViewData["Title"] = "Yeni Sifariş Yarat";
}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order</title>
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"> -->
    <link href="~/assets/style/newOrder.css" rel="stylesheet">
</head>

<body>
    <h1>Yeni Sifariş</h1>
    <div class="container">
        <form enctype="multipart/form-data" method="post">
            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
            <div asp-validation-summary="ModelOnly"></div>

            <div class="form-heading">
                <div class="rows">
                    <div class="row">
                        <div class="text-section">
                            <label asp-for="OrderNo" class="text-label">Sifariş No</label>
                            <span asp-validation-for="OrderNo"></span>
                            <input asp-for="OrderNo" type="text" class="text-input" />
                        </div>
                        <div class="text-section">
                            <label asp-for=InvoiceNo class="text-label">Veybil</label>
                            <input asp-for="InvoiceNo" type="text" class="text-input" required />
                        </div>
                    </div>

                    <div class="row">
                        <div class="text-section">
                            <label class="text-label">Klientin Kodu</label>
                            <input type="text" id="clientCode" class="text-input" readonly />
                        </div>
                        <div class="col">
                            <select class="form-control" id="receiverSelect" asp-for="ReceiverId" asp-items="ViewBag.Receiver">
                                <option value="">Select Receiver</option>
                            </select>
                            <span class="text-danger" asp-validation-for="ReceiverId"></span>
                        </div>
                    </div>


                </div>
                <div style="width: 350px;">
                    <label asp-for="ZengEdeninAdi" class="text-label">Zəng Edənin Adı</label>
                    <input asp-for="ZengEdeninAdi" type="text" class="text-input" required />
                </div>
            </div>
            <div class="main-colls">
                <div class="left-coll">
                    <div class="sender">
                        <div class="sender-heading">
                            <h2>GÖNDƏRƏN</h2>
                           
                        </div>
                        <div class="sender-main">
                            <div class="text-section" style="width: 500px;">
                                <label asp-for="SenderName" class="text-label" style="width: 100px;">Göndərənin Adı</label>
                                <input asp-for="SenderName" type="text" class="text-input" style="width: 365px;" required>
                            </div>
                            <div class="text-section" style="width: 500px;">
                                <label asp-for="SenderAddress" class="text-label" style="width: 100px;">Ünvanı</label>
                                <input asp-for="SenderAddress" type="text" class="text-input" style="width: 365px;" required>
                            </div>
                            <div class="text-section" style="width: 500px;">
                                <label asp-for="SenderPhoneNum" class="text-label" style="width: 100px;">Nömrəsi</label>
                                <input asp-for="SenderPhoneNum" class="text-input" style="width: 365px;" required>
                            </div>

                            <div class="text-section" style="width: 400px; font-size: 14px; margin: 5px 0;">
                                <label asp-for="DeliveryZoneId" style="font-size: 14px; padding:10px">Zona</label>
                                <select class="form-control form-control-sm" asp-for="DeliveryZoneId" asp-items="ViewBag.DeliveryZone"
                                        style="width: 250px;">
                                    <option disabled selected>Select Zone</option>
                                </select>
                                <span class="text-danger" asp-validation-for="DeliveryZoneId" style="font-size: 13px;"></span>
                            </div>


                          
                        </div>
                    </div>
                    <div>
                        <button class="opposite-button">ƏKS <span>&#8645;</span></button>
                    </div>
                    <div class="sender">
                        <div class="sender-heading">
                            <h2>ALAN</h2>
                            
                        </div>
                        <div class="sender-main">
                            <div class="text-section" style="width: 500px;">
                                <label asp-for="ReceiverName" class="text-label" style="width: 100px;">Adı</label>
                                <input asp-for="ReceiverName" type="text" class="text-input" style="width: 365px;">
                            </div>
                            <div class="text-section" style="width: 500px;">
                                <label asp-for="ReceiverAddress" class="text-label" style="width: 100px;">Ünvanı</label>
                                <input asp-for ="ReceiverAddress" type="text" class="text-input" style="width: 365px;">
                            </div>
                            <div class="text-section" style="width: 500px;">
                                <label asp-for="ReceiverPhoneNum" class="text-label" style="width: 100px;">Nömrəsi</label>
                                <input asp-for="ReceiverPhoneNum"  class="text-input" style="width: 365px;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="right-coll">
                    <div class="form-group">
                        <label asp-for="StartDate"></label>
                        <input asp-for="StartDate" class="form-control" type="datetime-local" />
                    </div>


                    <div class="text-section" style="width: 400px; font-size: 14px; margin: 5px 0;">
                        <!-- Service -->
                        <div style="margin-bottom: 25px;">
                            <label asp-for="ServiceId" style="display: block; margin-bottom: 5px;">Xidmət Növü </label>
                            <select class="form-control" asp-for="ServiceId" asp-items='new SelectList(ViewBag.Service,"Id","ServiceType")' style="margin-bottom: 5px;">
                                <option>Select Service</option>
                            </select>
                            <span class="text-danger" asp-validation-for="ServiceId" style="display: block;"></span>
                        </div>

                        <!-- Courier -->
                        <div style="margin-bottom: 25px;">
                            <label asp-for="CourierId" style="display: block; margin-left: 30px;">Kuryer</label>
                            <select class="form-control" asp-for="CourierId" asp-items='new SelectList(ViewBag.Courier,"CourierId","CourierName")' style="margin-left: 30px;">
                                <option>Select Sender</option>
                            </select>
                            <span class="text-danger" asp-validation-for="CourierId" style="display: block;"></span>
                        </div>
                    </div>



                    <div class="desc-text">
                        <label asp-for="OrderPrice" class="text-label">Qiymət</label>
                        <input asp-for="OrderPrice" type="number" id="price" class="desc-input" placeholder="Məs: 100.00">
                    </div>

                    <div class="desc-text">
                        <label asp-for="SpecialPrice" class="text-label">Xüsusi Qiymət</label>
                        <input asp-for="SpecialPrice" type="number" id="specialPrice" class="desc-input" placeholder="Kargo və s.">
                    </div>

                    <div class="desc-text">
                        <label asp-for="Discount" class="text-label">Güzəşt %</label>
                        <input asp-for="Discount" type="number" id="discountPercent" class="desc-input" placeholder="Məs: 10">
                    </div>

                    <div class="desc-text">
                        <label class="text-label">Cəmi</label>
                        <input type="text" id="subtotal" class="desc-input" readonly>
                    </div>

                    <div class="desc-text">
                        <label  class="text-label">ƏDV (18%)</label>
                        <input  type="text" id="vat" class="desc-input" readonly>
                    </div>

                    <div class="desc-text">
                        <label class="text-label">Yekun</label>
                        <input type="text" id="total" class="desc-input" readonly>
                    </div>

                    <div class="desc-text">
                        <label asp-for="Note" class="text-label">Əlavə Qeyd</label>
                        <textarea asp-for="Note" class="desc-text-ar"></textarea>
                    </div>

                    <div class="btns">
                        <button type="reset" class="btn-reset">Təmizlə</button>
                        <button type="submit" class="btn-submit">Qeyd Et Və Çıx</button>
                    </div>
                </div>
            </div>
        </form>
    </div>


</body>
</html>


<script>
    const priceEl = document.getElementById('price');
    const specialEl = document.getElementById('specialPrice');
    const discountEl = document.getElementById('discountPercent');
    const subtotalEl = document.getElementById('subtotal');
    const vatEl = document.getElementById('vat');
    const totalEl = document.getElementById('total');

    [priceEl, specialEl, discountEl].forEach(el =>
        el.addEventListener('input', calculateAll)
    );

    function calculateAll() {
        const price = parseFloat(priceEl.value) || 0;
        const special = parseFloat(specialEl.value) || 0;
        const discount = parseFloat(discountEl.value) || 0;

        // 1) Cəmi
        const sum = price + special;
        subtotalEl.value = sum.toFixed(2);

        // 2) Endirim məbləği
        const discountAmount = sum * (discount / 100);

        // 3) Endirimdən sonra qalan
        const netAfterDiscount = sum - discountAmount;

        // 4) ƏDV (18%)
        const vatAmount = netAfterDiscount * 0.18;
        vatEl.value = vatAmount.toFixed(2);

        const grandTotal = netAfterDiscount + vatAmount;
        totalEl.value = grandTotal.toFixed(2);
    }


    const clientsData = {
        "1": {
            "Göndərənin Adı": "ABC Şirkət",
            "Ünvanı": "Nərimanov rayonu, Bakı",
            "Nömrəsi": "0123456789",
            "Zona": "North"
        },
        "2": {
            "Göndərənin Adı": "XYZ MMC",
            "Ünvanı": "Yasamal rayonu, Bakı",
            "Nömrəsi": "0551234567",
            "Zona": "South"
        }
    };

    const clientSelect = document.querySelector('.client-select');
    const senderSections = Array.from(
        document.querySelectorAll('.sender-main .text-section')
    );

    function findField(labelText) {
        const section = senderSections.find(sec => {
            const lbl = sec.querySelector('label.text-label');
            return lbl && lbl.textContent.trim() === labelText;
        });
        return section && section.querySelector('input, select');
    }

    clientSelect.addEventListener('change', () => {
        const id = clientSelect.value;
        const data = clientsData[id] || {};

        ['Göndərənin Adı', 'Ünvanı', 'Nömrəsi', 'Zona']
            .forEach(key => {
                const field = findField(key);
                if (field) {
                    field.value = data[key] || '';
                }
            });
    });


    $('#receiverSelect').on('change', function () {
        var receiverId = $(this).val();
    if (receiverId) {
        $.ajax({
            url: '/Receiver/GetClientCode', // Controller/Action
            type: 'GET',
            data: { id: receiverId },
            success: function (response) {
                $('#clientCode').val(response.clientCode);
            },
            error: function () {
                $('#clientCode').val('');
                alert('Kod tapılmadı və ya xəta baş verdi.');
            }
        });
        } else {
        $('#clientCode').val('');
        }
    });


</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}