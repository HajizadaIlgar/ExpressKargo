@using YunusExpress_MVC.Models
@using YunusExpress_MVC.ViewModels
@model OrderCreateVm

@{
    Layout = null;
    ViewData["Title"] = "Yeni Sifariş Yarat";
}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Yeni Sifariş</title>
  <link href="~/assets/style/newOrder.css" rel="stylesheet">
</head>

<body>
  <h1>Yeni Sifariş</h1>
  <div class="container">
    <form>
      <div class="vcontainer">
        <div class="form-heading">
          <div class="rows">
            <div class="row">
              <div class="text-section">
                <label asp-for="OrderNo" class="text-label" style="width: 90px;">Sifariş No</label>
                <input asp-for="OrderNo" type="text" class="text-input" style="width:100px;" />
              </div>
              <div class="text-section">
                <label asp-for="InvoiceNo" class="text-label" style="width:35px;">Veybil</label>
                <input asp-for="InvoiceNo" type="text" class="text-input" style="width:100px;" />
              </div>
            </div>
             <div class="row">
                                           <!-- Receiver seçimi üçün input -->
                        <div class="text-section">
                            <label style="width:90px;" class="text-label">Klientin Kodu</label>
                            <input class="text-input" list="receiverList" id="receiverInput" placeholder="Receiver seçin" style="width:100px;" />
                            <datalist id="receiverList"></datalist>
                        </div>

                        <!-- Müştəri kodunu göstərən input -->
                        <div class="text-section">
                            <input type="text" id="clientCode" class="text-input" readonly style="width:100px;" />
                        </div>


                    </div>
          </div>
          <div style="width: 350px;">
            <label asp-for="ZengEdeninAdi" class="text-label">Zəng Edənin Adı</label>
            <input asp-for="ZengEdeninAdi" type="text" class="text-input" style="width:100px;" />
          </div>
        </div>
        <div class="main-colls">
          <div class="left-coll">
            <div class="sender">
              <div class="sender-heading">
                <h2>GÖNDƏRƏN</h2>
              </div>
              <div class="sender-main">
                <div class="text-section" style="width: 300px;">
                  <label class="text-label" style="width: 100px;">Göndərənin Adı</label>
                  <input type="text" class="text-input" id="senderName">
                </div>
                <div class="text-section" style="width: 300px;">
                  <label class="text-label" style="width: 100px;">Ünvanı</label>
                  <input type="text" class="text-input" id="senderAdd">
                </div>
                <div class="text-section" style="width: 300px;">
                  <label class="text-label" style="width: 100px;">Nömrəsi</label>
                  <input type="number" class="text-input" id="senderNum">
                </div>
                 <div class="text-section" style="width: 300px;">
                                <label asp-for="DeliveryZoneId" class="text-label" style="width:93px">Zona</label>
                                <select class="input-select" asp-for="DeliveryZoneId" asp-items="ViewBag.DeliveryZone"
                                        style="width: 187px;">
                                    <option disabled selected>Select Zone</option>
                                </select>
                               
                 </div>
              </div>
            </div>
            <div>
                        <button onclick="transferValues()" type="button" class="opposite-button">ƏKS <span>&#8645;</span></button>
                    </div>
            <!-- SENDER  -->
            <div class="sender">
              <div class="sender-heading">
                <h2>ALAN</h2>
              </div>
              <div class="sender-main">
                <div class="text-section" style="width: 300px;">
                  <label class="text-label" style="width: 100px;">Göndərənin Adı</label>
                  <input type="text" class="text-input" id="acceptName">
                </div>
                <div class="text-section" style="width: 300px;">
                  <label class="text-label" style="width: 100px;">Ünvanı</label>
                  <input type="text" class="text-input" id="acceptAdd">
                </div>
                <div class="text-section" style="width: 300px;">
                  <label class="text-label" style="width: 100px;">Nömrəsi</label>
                  <input type="number" class="text-input" id="acceptNum">
                </div>

              </div>
            </div>
          </div>
          <div class="right-coll">
            <div class="desc-text">
              <label class="text-label">Tarix</label>
              <div class="desc-time">
                <input type="date" class="desc-input-t">
                <input type="time" class="desc-input-t">
              </div>
            </div>
            <div class="desc-text">
                    
                            <label asp-for="ServiceId" class="text-label">Xidmət Növü</label>
                            <select class="desc-select" asp-for="ServiceId" asp-items='new SelectList(ViewBag.Service,"Id","ServiceType")'>
                                <option>Select Service</option>
                            </select>
                    </div>

                        <div class="desc-text">
                            <label asp-for="CourierId" class="text-label">Kuryer</label>
                            <select class="desc-select" asp-for="CourierId" asp-items='new SelectList(ViewBag.Courier,"CourierId","CourierName")'>
                                <option>Kuryer Seçin</option>
                            </select>
                        </div>
            <div class="desc-text">
            @*   <label class="text-label">Kuryer 2</label>
              <input class="desc-input" list="clientCodes" name="clientCode">
              <datalist id="clientCodes">
                 <option value="001">
                <option value="002">
                <option value="003">
                <option value="004">
                <option value="005"> 
              </datalist> *@
            </div>

            <div class="desc-text">
              <label asp-for="OrderPrice" class="text-label">Qiymət</label>
              <input asp-for="OrderPrice" type="text" class="desc-input">
            </div>

            <div class="desc-text">
              <label asp-for="SpecialPrice" class="text-label">Xüsusi Qiymət</label>
              <input asp-for="SpecialPrice" type="text" class="desc-input">
            </div>
            <div class="desc-text">
              <label asp-for="Discount" class="text-label">Güzəşt %</label>
              <input asp-for="Discount" type="text" class="desc-input">
            </div>
            <div class="desc-text">
              <label class="text-label">Cəmi</label>
              <input type="text" class="desc-input">
            </div>
            <div class="desc-text">
              <label class="text-label">ƏDV (18%)</label>
              <input type="text" class="desc-input" readonly>
            </div>
            <div class="desc-text">
              <label class="text-label">Yekun</label>
              <input type="text" class="desc-input">
            </div>
            <div class="desc-text">
              <label asp-for="Note" class="text-label">Əlavə Qeyd</label>
              <textarea asp-for="Note" name="" class="desc-text-ar"></textarea>
            </div>
            <div class="btns">
              <button type="submit" class="btn-submit">Qeyd Et Və Çıx</button>
            </div>
          </div>
        </div>
        </div>
    </form>
    <div class="back-btn">
      <a asp-controller="Home" asp-action="Index">⬅</a>
    </div>
  </div>
</div>
</body>

</html>

<script>
                document.addEventListener("DOMContentLoaded", function () {
                    const errorContainer = document.getElementById("validation-err");

                    if (!errorContainer) return;

                    const errorSpans = errorContainer.querySelectorAll("span");

                    errorSpans.forEach(span => {
                        span.style.display = "none"; // heç vaxt görünməsin

                        const errorText = span.textContent.trim();

                        if (errorText !== "") {
                            const inputId = span.getAttribute("asp-validation-for"); // inputun ID-si span'da saxlanır

                            if (inputId) {
                                const input = document.getElementById(inputId);
                                if (input) {
                                    input.style.border = "1px solid red";
                                }
                            }
                        }
                    });
                });

    </script>
   <script>
                    let receivers = [];

                    document.addEventListener("DOMContentLoaded", async () => {
                        try {
                            const response = await fetch('/Order/ReceiverData');
                            if (!response.ok) throw new Error("Şəbəkə xətası!");

                            receivers = await response.json();

                            const datalist = document.getElementById("receiverList");
                            datalist.innerHTML = "";

                            // Option dəyərlərini: "1 Veysel_MMC" şəklində göstər
                            receivers.forEach(receiver => {
                                const option = document.createElement("option");
                                option.value = `${receiver.clientCode} ${receiver.receiverName}`; // Görünən dəyər
                                option.dataset.clientcode = receiver.clientCode;  // clientCode məlumatı
                                option.dataset.receivername = receiver.receiverName;  // receiverName məlumatı
                                datalist.appendChild(option);
                            });

                        } catch (error) {
                            console.error("Receiver dataları alınmadı:", error);
                        }
                    });

                    // Seçim edildikdə uyğun olaraq inputlara doldur
                    document.getElementById("receiverInput").addEventListener("input", function () {
                        const inputVal = this.value;
                        const options = document.querySelectorAll("#receiverList option");

                        for (const option of options) {
                            if (option.value === inputVal) {
                                const receiverName = option.dataset.clientcode || '';  // clientCode
                                const clientCode = option.dataset.receivername || '';  // receiverName

                                // Əsas inputlara dəyərləri yaz
                                document.getElementById("clientCode").value = clientCode;
                                document.getElementById("receiverInput").value = receiverName;

                                // Əlavə inputlara uyğun receiver taparaq yaz
                                const matchedReceiver = receivers.find(r =>
                                    `${r.clientCode} ${r.receiverName}` === inputVal
                                );

                                if (matchedReceiver) {
                                    document.getElementById("senderName").value = matchedReceiver.receiverName;
                                    document.getElementById("senderAdd").value = matchedReceiver.receiverAddress;
                                    document.getElementById("senderNum").value = matchedReceiver.receiverPhoneNum;
                                }

                                return;
                            }
                        }

                        // Əgər uyğunluq tapılmazsa — sahələri təmizlə
                        document.getElementById("clientCode").value = "";
                        document.getElementById("senderName").value = "";
                        document.getElementById("senderAdd").value = "";
                        document.getElementById("senderNum").value = "";
                    });
                </script>

<script>

    function transferValues() {
        const senderName = document.getElementById("senderName");
        const senderAdd = document.getElementById("senderAdd");
        const senderNum = document.getElementById("senderNum");

        const acceptName = document.getElementById("acceptName");
        const acceptAdd = document.getElementById("acceptAdd");
        const acceptNum = document.getElementById("acceptNum");

        // Swap values using a temporary variable
        [senderName.value, acceptName.value] = [acceptName.value, senderName.value];
        [senderAdd.value, acceptAdd.value] = [acceptAdd.value, senderAdd.value];
        [senderNum.value, acceptNum.value] = [acceptNum.value, senderNum.value];
    }
  
    const clientSelect = document.querySelector('.client-select');
    const senderSections = Array.from(
        document.querySelectorAll('.sender-main .text-section')
    );

    function findField(labelText) {
        const section = senderSections.find(sec => {
            const lbl = sec.querySelector('label.text-label');
            return lbl && lbl.textContent.trim() === labelText;
        });
        return section && section.querySelector('input, select');
    }

    clientSelect.addEventListener('change', () => {
        const id = clientSelect.value;
        const data = clientsData[id] || {};

        ['Göndərənin Adı', 'Ünvanı', 'Nömrəsi', 'Zona']
            .forEach(key => {
                const field = findField(key);
                if (field) {
                    field.value = data[key] || '';
                }
            });
    });


    $('#receiverSelect').on('change', function () {
        var receiverId = $(this).val();
    if (receiverId) {
        $.ajax({
            url: '/Receiver/GetClientCode', // Controller/Action
            type: 'GET',
            data: { id: receiverId },
            success: function (response) {
                $('#clientCode').val(response.clientCode);
            },
            error: function () {
                $('#clientCode').val('');
                alert('Kod tapılmadı və ya xəta baş verdi.');
            }
        });
        } else {
        $('#clientCode').val('');
        }
    });


</script>


<script>
    let receivers = [];

    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const response = await fetch('/Order/ReceiverData');
            if (!response.ok) throw new Error("Şəbəkə xətası!");
            receivers = await response.json();

            const datalist = document.getElementById("receiverList");
            datalist.innerHTML = "";

            receivers.forEach(receiver => {
                const option = document.createElement("option");
                option.value = `${receiver.clientCode} ${receiver.receiverName}`;
                option.dataset.clientcode = receiver.clientCode;
                option.dataset.receivername = receiver.receiverName;
                datalist.appendChild(option);
            });

        } catch (error) {
            console.error("Receiver dataları alınmadı:", error);
        }
    });

    document.getElementById("receiverInput").addEventListener("input", function () {
        const inputVal = this.value.trim();
        const clientCodeOnly = inputVal.split(" ")[0];

        const matchedReceiver = receivers.find(r => r.clientCode === clientCodeOnly);

        if (matchedReceiver) {
            document.getElementById("clientCode").value = matchedReceiver.receiverName;
            document.getElementById("receiverInput").value = matchedReceiver.clientCode;
            document.getElementById("isEDV").checked = matchedReceiver.isEDV === true;
        } else {
            document.getElementById("clientCode").value = "";
            document.getElementById("isEDV").checked = false;
        }

        // Yeni seçimdən sonra hesablama yenilənsin
        
    });

    
</script>

<script>
    const priceEl = document.getElementById('price');
    const specialEl = document.getElementById('specialPrice');
    const discountEl = document.getElementById('discountPercent');
    const subtotalEl = document.getElementById('subtotal');
    const totalEl = document.getElementById('total');
    const isEDVCheckbox = document.getElementById('isEDV');


    [priceEl, specialEl, discountEl, isEDVCheckbox].forEach(el =>
        el.addEventListener('input', calculateAll)
    );

    function calculateAll() {
        const price = parseFloat(priceEl.value) || 0;
        const special = parseFloat(specialEl.value) || 0;
        const discount = parseFloat(discountEl.value) || 0;

        const sum = price + special;
        subtotalEl.value = sum.toFixed(2);

        let net = sum;

        if (discount > 0) {
            const discountAmount = sum * (discount / 100);
            net -= discountAmount;
        }

        if (isEDVCheckbox.checked) {
            const vatAmount = net * 0.18;
            net += vatAmount;
        }

        totalEl.value = net.toFixed(2);
    }

    calculateAll();
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.3/dist/jquery.validate.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation-unobtrusive@3.2.12/dist/jquery.validate.unobtrusive.min.js"></script>
